# SeaweedFS service management for Aria Character Core
# Copyright (c) 2025-present K. S. Ernest (iFire) Lee
# SPDX-License-Identifier: MIT

import "install.just"

start-seaweedfs: install-seaweedfs
    #!/usr/bin/env bash
    echo "ðŸŒ± Starting SeaweedFS..."
    
    if [ "{{os()}}" = "linux" ]; then
        # Check if SeaweedFS is already running
        if pgrep -f "weed" > /dev/null; then
            echo "âœ… SeaweedFS is already running"
            exit 0
        fi
        
        # Start SeaweedFS master
        echo "ðŸš€ Starting SeaweedFS master..."
        sudo -u seaweedfs nohup weed master \
            -dir=/var/lib/seaweedfs/master \
            -port=9333 \
            > /var/log/seaweedfs/master.log 2>&1 &
        
        # Start SeaweedFS volume server
        echo "ðŸš€ Starting SeaweedFS volume server..."
        sudo -u seaweedfs nohup weed volume \
            -dir=/var/lib/seaweedfs/volume \
            -port=8080 \
            -mserver=localhost:9333 \
            > /var/log/seaweedfs/volume.log 2>&1 &
        
        # Start SeaweedFS filer
        echo "ðŸš€ Starting SeaweedFS filer..."
        sudo -u seaweedfs nohup weed filer \
            -dir=/var/lib/seaweedfs/filer \
            -port=8888 \
            -master=localhost:9333 \
            > /var/log/seaweedfs/filer.log 2>&1 &
        
        # Start SeaweedFS S3 gateway
        echo "ðŸš€ Starting SeaweedFS S3 gateway..."
        sudo -u seaweedfs nohup weed s3 \
            -dir=/var/lib/seaweedfs/s3 \
            -port=8333 \
            -filer=localhost:8888 \
            > /var/log/seaweedfs/s3.log 2>&1 &
        
        # Wait for S3 gateway to be ready
        echo "â³ Waiting for SeaweedFS S3 gateway to be ready..."
        timeout 30s bash -c 'until curl -sf http://localhost:8333 >/dev/null 2>&1; do echo "Waiting..."; sleep 2; done' || (echo "âŒ SeaweedFS S3 gateway failed to start" && exit 1)
        
        echo "âœ… SeaweedFS started successfully!"
    else
        echo "âš ï¸  SeaweedFS service management only supported on Linux"
    fi

stop-seaweedfs:
    #!/usr/bin/env bash
    echo "ðŸ›‘ Stopping SeaweedFS services..."
    pkill -f "weed s3" 2>/dev/null || true
    pkill -f "weed filer" 2>/dev/null || true
    pkill -f "weed volume" 2>/dev/null || true
    pkill -f "weed master" 2>/dev/null || true
    echo "âœ… SeaweedFS stopped"

seaweedfs-status:
    #!/usr/bin/env bash
    echo "ðŸ“Š SeaweedFS Status:"
    echo "Master: $(pgrep -f 'weed master' >/dev/null && echo 'âœ… RUNNING' || echo 'âŒ STOPPED')"
    echo "Volume: $(pgrep -f 'weed volume' >/dev/null && echo 'âœ… RUNNING' || echo 'âŒ STOPPED')"
    echo "Filer: $(pgrep -f 'weed filer' >/dev/null && echo 'âœ… RUNNING' || echo 'âŒ STOPPED')"
    echo "S3 Gateway: $(pgrep -f 'weed s3' >/dev/null && echo 'âœ… RUNNING' || echo 'âŒ STOPPED')"
    echo "Health: $(curl -sf http://localhost:8333 >/dev/null 2>&1 && echo 'âœ… HEALTHY' || echo 'âŒ UNHEALTHY')"

seaweedfs-logs:
    #!/usr/bin/env bash
    echo "ðŸ“‹ SeaweedFS Logs:"
    echo "=== Master Logs ==="
    tail -30 /var/log/seaweedfs/master.log 2>/dev/null || echo "No SeaweedFS master logs available"
    echo "=== Volume Logs ==="
    tail -30 /var/log/seaweedfs/volume.log 2>/dev/null || echo "No SeaweedFS volume logs available"
    echo "=== Filer Logs ==="
    tail -30 /var/log/seaweedfs/filer.log 2>/dev/null || echo "No SeaweedFS filer logs available"
    echo "=== S3 Logs ==="
    tail -30 /var/log/seaweedfs/s3.log 2>/dev/null || echo "No SeaweedFS S3 logs available"
